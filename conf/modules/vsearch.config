process {
    withName: VSEARCH_DEREPFULL {
        ext.args = [
            "--strand plus",
            "--sizeout",
            "--fasta_width 0",
            "-minuniquesize 2"
        ].join(' ')
    }
    withName: VSEARCH_CLUSTER_SIZE {
        ext.args = [
            "--strand plus",
            "--sizein",
            "--sizeout",
            "--relabel OTU_",
            "--id ${params.vsearch_cluster_id}",
            params.ont ? "--gapopen 4I/2E" : "" // see: https://groups.google.com/g/vsearch-forum/c/qs_9Zo6cc8c
        ].join(' ')
        publishDir = [
            path: { "${params.outdir}/samples/${meta.sample_id}/OTUs" },
            mode: params.publish_dir_mode,
            enabled: true,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }
    withName: VSEARCH_CLUSTER_UNOISE {
        ext.args = [
            "--minsize 8",
            "--unoise_alpha 2"
        ].join(' ')
    }   
    withName: VSEARCH_FASTQFILTER_READS {
        ext.args = [ 
            "--fastq_maxee ${params.max_expected_errors}",
            "--fastq_maxn ${params.max_ns}",
            params.iontorrent ? "--fastq_qmax 50" : "" // IonTorrent S5 output may exceed the normal limit of the phred scale (40)
        ].join(" ")
    }
    withName: VSEARCH_FASTQFILTER {
        ext.args = [ 
            params.non_overlapping ? "--fastq_minlen 50 --fastq_maxlen 1000" : "--fastq_minlen ${params.amplicon_min_length} --fastq_maxlen ${params.amplicon_max_length}",
            ( params.iontorrent || params.ont ) ? "--fastq_qmax 50" : "" // IonTorrent S5 output may exceed the normal limit of the phred scale (40)
        ].join(" ")
    }
    withName: VSEARCH_FASTQMERGE {
        ext.args = "--fastq_allowmergestagger --fastq_maxdiffs ${params.merging_max_mismatch}"
    }
    withName: VSEARCH_UCHIME_DENOVO {
        ext.args = [
            params.ont ? "--gapopen 4I/2E" : "" // see: https://groups.google.com/g/vsearch-forum/c/qs_9Zo6cc8c
        ].join(" ")
        publishDir = [
            path: { "${params.outdir}/samples/${meta.sample_id}/vsearch/" },
            mode: params.publish_dir_mode,
            enabled: true,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }
    withName: 'VSEARCH_DEREPFULL|VSEARCH_CLUSTER_SIZE|VSEARCH_FASTQFILTER_READS' {
        publishDir = [
            path: { "${params.outdir}/samples/${meta.sample_id}/vsearch/" },
            mode: params.publish_dir_mode,
            enabled: true,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }
    withName: VSEARCH_SORTBYSIZE {
        ext.args = "--minsize 3 --sizein --sizeout"
        publishDir = [
            path: { "${params.outdir}/vsearch/raw" },
            mode: params.publish_dir_mode,
            enabled: false,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }
    withName: 'VSEARCH_FASTQMERGE|VSEARCH_FASTQFILTER|VSEARCH_FASTQJOIN' {
        publishDir = [
            path: { "${params.outdir}/vsearch/raw" },
            mode: params.publish_dir_mode,
            enabled: false,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }
    
}